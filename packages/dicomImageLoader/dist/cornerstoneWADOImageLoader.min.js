/*! cornerstoneWADOImageLoader - v0.2.2 - 2014-04-18 | (c) 2014 Chris Hafey | https://github.com/chafey/cornerstoneWADOImageLoader */
var cornerstoneWADOImageLoader=function(a,b,c){"use strict";function d(a){return"RGB"===a||"PALETTE COLOR"===a||"YBR_FULL"===a||"YBR_FULL_422"===a||"YBR_PARTIAL_422"===a||"YBR_PARTIAL_420"===a||"YBR_RCT"===a?!0:!1}function e(a,b,e){var f=new Uint8Array(a),g=dicomParser.parseDicom(f),h=g.string("x00280004"),i=d(h);return i===!1?c.makeGrayscaleImage(b,g,f,h,e):c.makeColorImage(b,g,f,h,e)}function f(b){var c=a.Deferred(),d=b;d=d.replace("dicomweb","http"),d=d.replace("dicomwebs","https");var f=d.indexOf("frame="),g=0;if(-1!==f){var h=d.substr(f+6);g=parseInt(h),d=d.substr(0,f-1)}var i=new XMLHttpRequest;return i.open("get",d,!0),i.responseType="arraybuffer",i.onreadystatechange=function(){if(4===i.readyState)if(200===i.status){var a=e(i.response,b,g);c.resolve(a)}else c.reject()},i.send(),c}return void 0===c&&(c={}),b.registerImageLoader("dicomweb",f),b.registerImageLoader("dicomwebs",f),c}($,cornerstone,cornerstoneWADOImageLoader),cornerstoneWADOImageLoader=function(a){"use strict";function b(a,b){if(void 0===a)throw"decodeRGB: rgbBuffer must not be undefined";if(a.length%3!==0)throw"decodeRGB: rgbBuffer length must be divisble by 3";for(var c=a.length/3,d=0,e=0,f=0;c>f;f++)b[e++]=a[d++],b[e++]=a[d++],b[e++]=a[d++],b[e++]=255}return void 0===a&&(a={}),a.decodeRGB=b,a}(cornerstoneWADOImageLoader),cornerstoneWADOImageLoader=function(a){"use strict";function b(a,b){if(void 0===a)throw"decodeRGB: ybrBuffer must not be undefined";if(a.length%3!==0)throw"decodeRGB: ybrBuffer length must be divisble by 3";for(var c=a.length/3,d=0,e=0,f=0;c>f;f++){var g=a[d++],h=a[d++],i=a[d++];b[e++]=g+1.402*(i-128),b[e++]=g-.34414*(h-128)-.71414*(i-128),b[e++]=g+1.772*(h-128),b[e++]=255}}return void 0===a&&(a={}),a.decodeYBRFull=b,a}(cornerstoneWADOImageLoader),cornerstoneWADOImageLoader=function(a){"use strict";function b(a){var b=a.string("x00280030");if(b&&b.length>0){var c=b.split("\\");return{row:parseFloat(c[0]),column:parseFloat(c[1])}}return{row:void 0,column:void 0}}return void 0===a&&(a={}),a.getPixelSpacing=b,a}(cornerstoneWADOImageLoader),cornerstoneWADOImageLoader=function(a){"use strict";function b(a){var b={intercept:0,slope:1},c=a.floatString("x00281052"),d=a.floatString("x00281053");return c&&(b.intercept=c),d&&(b.slope=d),b}return void 0===a&&(a={}),a.getRescaleSlopeAndIntercept=b,a}(cornerstoneWADOImageLoader),cornerstoneWADOImageLoader=function(a){"use strict";function b(a){var b={windowCenter:void 0,windowWidth:void 0},c=a.floatString("x00281050"),d=a.floatString("x00281051");return c&&(b.windowCenter=c),d&&(b.windowWidth=d),b}return void 0===a&&(a={}),a.getWindowWidthAndCenter=b,a}(cornerstoneWADOImageLoader),cornerstoneWADOImageLoader=function(a){"use strict";function b(b,c,e,f,g,h){d.height=g,d.width=f;var i,j=b.elements.x7fe00010,k=j.dataOffset,l=b.string("x00020010"),m=f*g*3,n=k+h*m,o=d.getContext("2d"),p=o.createImageData(f,g);if("RGB"===e)return i=new Uint8Array(c.buffer,n),a.decodeRGB(i,p.data),p;if("YBR_FULL"===e)return i=new Uint8Array(c.buffer,n),a.decodeYBRFull(i,p.data),p;if("YBR_FULL_422"===e&&"1.2.840.10008.1.2.4.50"===l){i=dicomParser.readEncapsulatedPixelData(b,h);var q=new Blob([i],{type:"image/png"}),r=new FileReader;return r.readAsBinaryString(q),r.onload=function(){var a=new Image;a.onload=function(){o.drawImage(this,0,0)},a.onerror=function(){},a.src="data:image/jpeg;base64,"+window.btoa(r.result)},o.getImageData(0,0,f,g)}throw"no codec for "+e}function c(c,f,g,h,i){function j(){return u.data}function k(){return u}function l(){if(e===c)return d;d.height=n,d.width=o;var a=d.getContext("2d");return a.putImageData(u,0,0),e=c,d}var m=a.getPixelSpacing(f),n=f.uint16("x00280010"),o=f.uint16("x00280011"),p=a.getRescaleSlopeAndIntercept(f),q=4,r=n*o,s=r*q,t=a.getWindowWidthAndCenter(f),u=b(f,g,h,o,n,i),v={imageId:c,minPixelValue:0,maxPixelValue:255,slope:p.slope,intercept:p.intercept,windowCenter:t.windowCenter,windowWidth:t.windowWidth,getPixelData:j,getImageData:k,getCanvas:l,rows:n,columns:o,height:n,width:o,color:!0,columnPixelSpacing:m.column,rowPixelSpacing:m.row,data:f,invert:!1,sizeInBytes:s};return void 0===v.windowCenter&&(v.windowWidth=256,v.windowCenter=127),v}void 0===a&&(a={});var d=document.createElement("canvas"),e="";return a.makeColorImage=c,a}(cornerstoneWADOImageLoader),cornerstoneWADOImageLoader=function(a){"use strict";function b(a){{var b=a.uint16("x00280103"),c=a.uint16("x00280100");a.string("x00280004")}return 0===b&&8===c?1:0===b&&16===c?2:1===b&&16===c?3:void 0}function c(a,c,d,e,f){var g=b(a),h=a.elements.x7fe00010,i=h.dataOffset,j=d*e,k=0;return 1===g?(k=i+f*j,new Uint8Array(c.buffer,k)):2===g?(k=i+f*j*2,new Uint16Array(c.buffer,k)):3===g?(k=i+f*j*2,new Int16Array(c.buffer,k)):void 0}function d(a){var c=b(a);if(1===c)return 1;if(2===c||3===c)return 2;throw"unknown pixel format"}function e(a){for(var b=65535,c=-32768,d=a.length,e=a,f=0;d>f;f++){var g=e[f];b=Math.min(b,g),c=Math.max(c,g)}return{min:b,max:c}}function f(b,f,g,h,i){function j(){return t}var k=a.getPixelSpacing(f),l=f.uint16("x00280010"),m=f.uint16("x00280011"),n=a.getRescaleSlopeAndIntercept(f),o=d(f),p=l*m,q=p*o,r="MONOCHROME1"===h,s=a.getWindowWidthAndCenter(f),t=c(f,g,m,l,i),u=e(t),v={imageId:b,minPixelValue:u.min,maxPixelValue:u.max,slope:n.slope,intercept:n.intercept,windowCenter:s.windowCenter,windowWidth:s.windowWidth,getPixelData:j,rows:l,columns:m,height:l,width:m,color:!1,columnPixelSpacing:k.column,rowPixelSpacing:k.row,data:f,invert:r,sizeInBytes:q};if(void 0===v.windowCenter){var w=v.maxPixelValue*v.slope+v.intercept,x=v.minPixelValue*v.slope+v.intercept;v.windowWidth=w-x,v.windowCenter=(w+x)/2}return v}return void 0===a&&(a={}),a.makeGrayscaleImage=f,a}(cornerstoneWADOImageLoader);